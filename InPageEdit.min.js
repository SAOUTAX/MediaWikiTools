(function(W){typeof define=="function"&&define.amd?define(W):W()})(function(){"use strict";const W=ye(document?.currentScript?.src);function ye(e=""){return e=e.split("?")[0],e.endsWith(".js")?e.includes("/dist/")?e.split("/dist/")[0]:e.split("/").slice(0,-1).join("/"):e.replace(/\/$/,"")}function xe(e=""){return`${W}/${e.replace(/^\/+/,"")}`}function le(e,i){return $.ajax({url:e,dataType:"script",crossDomain:!0,cache:!i})}const S="14.5.2",h=mw.config.get(),U=()=>new mw.Api({parameters:{formatversion:2,format:"json"},ajax:{headers:{"Api-User-Agent":`InPageEdit-v2/${S}`}}});async function _e(){mw.config.set("wgUserRights",[]),mw.config.set("wgUserIsBlocked",!1),mw.config.set("wgSpecialPageAliases",[]);const{query:{users:e,userinfo:i,specialpagealiases:n}}=await U().get({action:"query",ususers:h.wgUserName,meta:["userinfo","siteinfo"],list:["users"],uiprop:["rights"],siprop:["specialpagealiases"],usprop:["blockinfo"]});return e?.[0].blockid&&mw.config.set("wgUserIsBlocked",!0),mw.config.set("wgUserRights",i?.rights||[]),mw.config.set("wgSpecialPageAliases",n),{users:e,userinfo:i,specialpagealiases:n}}const Y="https://www.ipe.wiki/",X="https://analytics.ipe.wiki/api",ce="https://analytics.ipe.wiki",G="https://github.com/inpageedit/inpageedit-v2",R="https://ipe-plugins.js.org",de="https://github.com/inpageedit/Plugins",Pe="https://ipe-plugins.js.org/specialNotice.json",fe="https://www.ipe.wiki/update/",Ne=Object.freeze(Object.defineProperty({__proto__:null,aboutUrl:Y,analyticsApi:X,analyticsDash:ce,githubLink:G,pluginCDN:R,pluginGithub:de,specialNotice:Pe,updatelogsUrl:fe},Symbol.toStringTag,{value:"Module"})),Ie=[`${R}/skins/ipe-default.css`,`${R}/lib/ssi-modal/ssi-modal.css`,"https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"];function Ee(e=!1){Ie.forEach(i=>{if(e){const n=new URL(i);n.searchParams.set(Date.now(),"no_cache"),i=""+n}$("head").prepend($("<link>",{href:i,rel:"stylesheet","data-ipe":"style"}))})}const qe=2*60*60*1e3,Se=xe("/dist/i18n/languages.json"),pe="InPageEdit",Z="i18n-cache-"+pe+"-content",ue="i18n-cache-"+pe+"-timestamp";async function Ce(e){const i=new Date().getTime();if(h.wgUserLanguage==="qqx")return console.warn("[InPageEdit] User language is qqx"),!0;if(localStorage.getItem(Z)&&i-localStorage.getItem(ue)<qe&&!e){var n={};try{n=JSON.parse(localStorage.getItem(Z))}catch{return console.warn("[InPageEdit] i18n 数据不合法"),await K(),!0}return n.en||(console.warn("[InPageEdit] i18n 数据可能已损坏"),await K()),!0}else return await K(),!0}function je(e){const i=new Date().getTime();e=JSON.stringify(e),localStorage.setItem(Z,e),localStorage.setItem(ue,i)}async function K(){console.time("[InPageEdit] 从远程获取 i18n 数据");var e=await $.getJSON(Se,{cache:!1,timestamp:new Date().getTime()});return typeof e!="object"&&(e={}),je(e),console.timeEnd("[InPageEdit] 从远程获取 i18n 数据"),e}const ee="InPageEdit",Le=h.wgUserLanguage,De={ab:"ru",ace:"id",aln:"sq",als:"gsw",an:"es",anp:"hi",arn:"es",arz:"ar",av:"ru",ay:"es",ba:"ru",bar:"de","bat-smg":"sgs",bcc:"fa","be-x-old":"be-tarask",bh:"bho",bjn:"id",bm:"fr",bpy:"bn",bqi:"fa",bug:"id","cbk-zam":"es",ce:"ru",ckb:"ckb-arab",crh:"crh-latn","crh-cyrl":"ru",csb:"pl",cv:"ru","de-at":"de","de-ch":"de","de-formal":"de",dsb:"de",dtp:"ms",eml:"it",ff:"fr","fiu-vro":"vro",frc:"fr",frp:"fr",frr:"de",fur:"it",gag:"tr",gan:"gan-hant","gan-hans":"zh-hans","gan-hant":"zh-hant",gl:"pt",glk:"fa",gn:"es",gsw:"de",hif:"hif-latn",hsb:"de",ht:"fr",ii:"zh-cn",inh:"ru",iu:"ike-cans",jut:"da",jv:"id",kaa:"kk-latn",kbd:"kbd-cyrl","kbd-cyrl":"ru",khw:"ur",kiu:"tr",kk:"kk-cyrl","kk-arab":"kk-cyrl","kk-cn":"kk-arab","kk-kz":"kk-cyrl","kk-latn":"kk-cyrl","kk-tr":"kk-latn",kl:"da",koi:"ru","ko-kp":"ko",krc:"ru",ks:"ks-arab",ksh:"de",ku:"ku-latn","ku-arab":"ckb",kv:"ru",lad:"es",lb:"de",lbe:"ru",lez:"ru",li:"nl",lij:"it",liv:"et",lmo:"it",ln:"fr",ltg:"lv",lzz:"tr",mai:"hi","map-bms":"jv",mg:"fr",mhr:"ru",min:"id",mo:"ro",mrj:"ru",mwl:"pt",myv:"ru",mzn:"fa",nah:"es",nap:"it",nds:"de","nds-nl":"nl","nl-informal":"nl",no:"nb",os:"ru",pcd:"fr",pdc:"de",pdt:"de",pfl:"de",pms:"it","pt-br":"pt",qu:"es",qug:"qu",rgn:"it",rmy:"ro",rue:"uk",ruq:"ruq-latn","ruq-cyrl":"mk","ruq-latn":"ro",sa:"hi",sah:"ru",scn:"it",sg:"fr",sgs:"lt",shi:"ar",simple:"en",sli:"de",sr:"sr-ec",srn:"nl",stq:"de",su:"id",szl:"pl",tcy:"kn",tg:"tg-cyrl",tt:"tt-cyrl","tt-cyrl":"ru",ty:"fr",udm:"ru",ug:"ug-arab",uk:"ru",vec:"it",vep:"et",vls:"nl",vmf:"de",vot:"fi",vro:"et",wa:"fr",wo:"fr",wuu:"zh-hans",xal:"ru",xmf:"ka",yi:"he",za:"zh-hans",zea:"nl",zh:"zh-hans","zh-classical":"lzh","zh-cn":"zh-hans","zh-hant":"zh-hans","zh-hk":"zh-hant","zh-min-nan":"nan","zh-mo":"zh-hk","zh-my":"zh-sg","zh-sg":"zh-hans","zh-tw":"zh-hant","zh-yue":"yue"};function Ue(e){try{return JSON.parse(e)}catch{return{}}}function ze(e,...i){return i.forEach(function(n,r){var s=new RegExp("\\$"+(r+1),"g");e=e.replace(s,n)}),e}function te(e,i,n,r){return i=i||e,e=n?e:mw.util.getUrl(e),i=mw.html.escape(i),e=mw.html.escape(e),r=r?'rel="noopener" target="_blank"':"",'<a href="'+e+'" title="'+i+'"'+r+">"+i+"</a>"}function Te(e){var i=document.implementation.createHTMLDocument(""),n=$.parseHTML(e,i,!1),r=$("<div>",i).append(n),s=["title","style","class"],a=["b","br","code","del","em","i","s","strong","span","u"];return r.find("*").each(function(){var o=$(this),l=o.prop("tagName").toLowerCase(),c,w,k;if(a.indexOf(l)===-1){mw.log("[I18n-js] Disallowed tag in message: "+l),o.remove();return}c=o.prop("attributes"),w=Array.prototype.slice.call(c),w.forEach(function(u){if(s.indexOf(u.name)===-1){mw.log("[I18n-js] Disallowed attribute in message: "+u.name+", tag: "+l),o.removeAttr(u.name);return}u.name==="style"&&(k=o.attr("style"),k.indexOf("url(")>-1?(mw.log("[I18n-js] Disallowed url() in style attribute"),o.removeAttr("style")):k.indexOf("var(")>-1&&(mw.log("[I18n-js] Disallowed var() in style attribute"),o.removeAttr("style")))})}),r.prop("innerHTML")}function Re(e){var i=/\[((?:https?:)?\/\/.+?) (.+?)\]/g,n=/\[\[([^|]*?)\]\]/g,r=/\[\[(.+?)\|(.+?)\]\]/g,s=/\{\{PLURAL:(\d+)\|(.+?)\}\}/gi,a=/\{\{GENDER:([^|]+)\|(.+?)\}\}/gi;return e.indexOf("<")>-1&&(e=Te(e)),e.replace(i,function(o,l,c){return te(l,c,!0,!0)}).replace(n,function(o,l){return te(l)}).replace(r,function(o,l,c){return te(l,c)}).replace(s,function(o,l,c){return mw.language.convertPlural(Number(l),c.split("|"))}).replace(a,function(o,l,c){return mw.language.gender(l,c.split("|"))})}function ie(e,...i){return e=ze(e,...i),e=Re(e),e}function me(e,i,...n){const r=localStorage.getItem("i18n-cache-"+ee+"-content")||"{}";if(e==="qqx"){var s="";return n.length>0&&(s=": "+n.join(", ")),`(${ee.toLowerCase()}-${i}${s})`}var a=Ue(r),o=window.InPageEdit||{},l=o.i18n||{};return l[e]&&l[e][i]?ie(l[e][i],...n):l[i]?ie(l[i],...n):a[e]&&a[e][i]?ie(a[e][i],...n):e==="en"?`(${ee}-${i})`:(e=De[e]||"en",me(e,i,...n))}const t=function(e,...i){return me(Le,e,...i)},{getUrl:Be}=mw.util,y="<br>",Ae="<hr>",J=({page:e,link:i,href:n,text:r,html:s})=>{n=n||i||"javascript:void(0);",e&&(n=Be(e)),s=s||r,e&&!s&&(s=e),s||(s=n);let a="";return/^https?:\/\//.test(n)&&(a="_blank"),$("<a>",{href:n,rel:"noopener",target:a,html:s})},L='<div class="ipe-progress" style="width: 100%"><div class="ipe-progress-bar"></div></div>';class O{static get(){return $.ajax({url:R+"/index.json",dataType:"json",crossDomain:!0,cache:!1})}static saveCache(i){var n=window.InPageEdit||{};n.cache=n.cache||{},n.cache.pluginList=i,window.InPageEdit=n}static loadCache(){var i=window.InPageEdit||{};return i.cache=i.cache||{},i.cache.pluginList}static load(i){/^https?:\/\//.test(i)?(mw.loader.load(i,/\.css$/i.test(i)?"text/css":void 0),console.info("[InPageEdit] 从远程加载非官方插件",i)):(le(R+"/plugins/"+i).then(()=>console.info("[InPageEdit] 插件 "+i+" 加载成功"),n=>console.warn("[InPageEdit] 插件 "+i+" 加载失败",n)),console.info("[InPageEdit] 从官方插件商店加载插件",i))}static initUserPlugin(){var i=P.get("plugins");typeof i=="object"&&i.length>0&&$.each(i,(n,r)=>{O.load(r)})}}const F=window.InPageEdit||{},P={_defaults:{doNotCollectMyInfo:!1,editMinor:!1,editSummary:t("preference-summary-default"),lockToolBox:!1,redLinkQuickEdit:!0,outSideClose:!0,watchList:"preferences",noConfirmEdit:!1,plugins:["toolbox.js","wiki-editor.js"]},get(e){var i=localStorage.getItem("InPageEditPreference")||"{}";try{i=JSON.parse(i)}catch{i={}}typeof F.myPreference=="object"&&Object.assign(i,F.myPreference);var n=$.extend({},P._defaults,i);return["watch","unwatch","preferences","nochange"].includes(n.watchList)||(n.watchList="preferences"),typeof e=="string"&&e!==""?n[e]?n[e]:null:n},set(e={},i=void 0){var n={};if(typeof e=="string"&&i!==void 0)n[e]=i;else if(typeof e=="object")n=e;else return;n=$.extend({},P.get(),n),n=JSON.stringify(n),localStorage.setItem("InPageEditPreference",n)},modal(){if($("#ipe-preference-form").length>0)return;mw.hook("pluginPreference").fire(),P.set();var e=P.get();x("plugin_setting");var i=$("<ul>",{class:"tab-list"}).append($("<li>").append($("<a>",{text:t("preference-tab-editor"),href:"#editor"})),$("<li>").append($("<a>",{text:t("preference-tab-plugin"),href:"#plugin"})),$("<li>").append($("<a>",{text:t("preference-tab-analysis"),href:"#analysis"})),$("<li>").append($("<a>",{text:t("preference-tab-another"),href:"#another"})),$("<li>").append($("<a>",{text:t("preference-tab-about"),href:"#about"})));function n(){const o=$("<section>").append(t("preference-savelocal-popup"),y,$("<textarea>",{style:"font-size: 12px; resize: none; width: 100%; height: 10em;",readonly:!0}).on("click",function(){this.select()}).val(`/** InPageEdit Preferences */
;(window.InPageEdit = window.InPageEdit || {}).myPreference = ${JSON.stringify(s.data(),null,2)}`));ssi_modal.dialog({className:"in-page-edit",center:!0,title:t("preference-savelocal-popup-title"),content:o,okBtn:{className:"btn btn-primary btn-single",label:t("ok")}})}var r=$("<div>",{class:"tab-content",style:"position: relative;"}).append($("<section>",{id:"editor"}).append($("<h3>",{text:t("preference-editor-title")}),$("<h4>",{text:t("preference-editHobbies-label")}),$("<label>").append($("<input>",{type:"checkbox",id:"editMinor"}),$("<span>",{text:t("preference-setMinor")})),$("<label>").append($("<input>",{type:"checkbox",id:"outSideClose"}),$("<span>",{text:t("preference-outSideClose")})),$("<label>").append($("<input>",{type:"checkbox",id:"noConfirmEdit"}),$("<span>",{text:t("preference-noConfirmEdit")})),$("<h4>",{text:t("preference-watchList-label")}),$("<label>").append($("<input>",{type:"radio",name:"watchList",value:"nochange"}),$("<span>",{text:t("preference-watchList-nochange")})),$("<label>").append($("<input>",{type:"radio",name:"watchList",value:"preferences"}),$("<span>",{html:t("preference-watchList-preferences")})),$("<label>").append($("<input>",{type:"radio",name:"watchList",value:"unwatch"}),$("<span>",{text:t("preference-watchList-unwatch")})),$("<label>").append($("<input>",{type:"radio",name:"watchList",value:"watch"}),$("<span>",{text:t("preference-watchList-watch")})),$("<h4>",{text:t("preference-summary-label")}),$("<label>",{for:"editSummary",style:"padding-left: 0; font-size: small",html:t("preference-editSummary")}),$("<input>",{id:"editSummary",style:"width: 96%",placeholder:"Edit via InPageEdit, yeah~"})),$("<section>",{id:"plugin"}).append($("<h3>",{text:t("preference-plugin-title")}),$("<div>",{id:"plugin-container",html:$(L).css({width:"96%",position:"absolute",top:"50%",transform:"translateY(-50%)"})}),$("<div>",{class:"plugin-footer"}).html(t("preference-plugin-footer",de))),$("<section>",{id:"analysis"}).append($("<h3>",{text:t("preference-analysis-title")}),$("<div>",{id:"analysis-container",html:$(L).css({width:"96%",position:"absolute",top:"50%",transform:"translateY(-50%)"})})),$("<section>",{id:"another"}).append($("<h3>",{text:t("preference-another-title")}),$("<h4>",{text:t("preference-display-label")}),$("<label>").append($("<input>",{type:"checkbox",id:"redLinkQuickEdit"}),$("<span>",{text:t("preference-redLinkQuickEdit")})),$("<div>").append($("<h4>",{text:"Custom skin (Not available yet)"}),$("<label>",{class:"choose-skin"}).append($("<input>",{type:"checkbox",id:"customSkinEnable",disabled:!0}),$("<span>"),$("<input>",{id:"customSkinUrl",disabled:!0,style:"width: calc(96% - 30px)",value:`${R}/skins/ipe-default.css`}))),$("<h4>",{text:t("preference-savelocal-popup-title")}),$("<button>",{class:"btn btn-secondary",id:"ipeSaveLocalShow",text:t("preference-savelocal-btn")}).on("click",n)),$("<section>",{id:"about"}).append($("<h3>",{text:t("preference-about-label")}),$("<div>",{style:"font-size: 12px; font-style: italic;"}).html(function(){return S.includes("-")?`v${S} (Canary)<br>${t("version-notice-canary")}`:`v${S}`}),$("<h4>",{text:"Portal"}),$("<button>",{class:"btn btn-secondary btn-single",onclick:"InPageEdit.about()",text:t("preference-aboutAndHelp")}),$("<button>",{class:"btn btn-secondary btn-single",style:"margin-top: .5em;",onclick:"InPageEdit.versionInfo()",text:t("preference-updatelog")}),$("<h4>",{text:"Join us"}),$("<p>").append($("<strong>",{text:"GitHub"}),": ",$("<a>",{href:G,text:G,rel:"noopener",target:"_blank"})),$("<p>").append($("<strong>",{text:"QQ Group"}),": ","1026023666"),Ae,$("<p>",{text:"InPageEdit is a useful MediaWiki JavaScript Plugin written with jQuery"}),$("<p>").append("© InPageEdit Copyright (C)"," 2019 - "+new Date().getFullYear()," Wjghj Project (机智的小鱼君), ",$("<a>",{href:"https://www.gnu.org/licenses/gpl-3.0-standalone.html",text:"GNU General Public License 3.0"})))),s=$("<div>",{class:"preference-tabber"}).append(i,r);i.find("a").on("click",function(o){o.preventDefault();var l=$(this),c=l.attr("href");c&&(i.find("a").removeClass("active"),r.find("section").removeClass("active"),l.addClass("active"),r.find(""+c).addClass("active"))}),r.find("input").on("change",function(){var o=$(this),l=o.attr("id")||o.prop("name"),c;o.prop("type")==="checkbox"?c=o.prop("checked"):c=o.val(),s.data(l,c),console.log("[InPageEdit] Preset preference",s.data())}),i.find("a:first").addClass("active"),r.find("section:first").addClass("active");function a(o){$.each(o,(l,c)=>{if(l==="plugins"){s.data(l,c.concat([])),r.find(".plugin-checkbox").each(function(){this.checked=c.includes(this.id)});return}s.data(l,c);const w=r.find("#"+l);w.length>0?typeof c=="string"?w.val(c):typeof c=="boolean"&&w.prop("checked",c):r.find("input[name="+l+"]").each(function(){this.checked=this.value===c})})}ssi_modal.show({sizeClass:"dialog",className:"in-page-edit ipe-preference",outSideClose:!1,title:t("preference-title")+" - "+S,content:s,buttons:[{label:t("preference-reset"),className:"btn btn-danger",method:function(o,l){ssi_modal.confirm({title:t("preference-reset-confirm-title"),content:t("preference-reset-confirm"),className:"in-page-edit",center:!0,okBtn:{label:t("ok"),className:"btn btn-danger"},cancelBtn:{label:t("cancel"),className:"btn"}},c=>{if(c)typeof F.myPreference<"u"?a(P._defaults):(P.set(P._defaults),l.close());else return!1})}},{label:t("preference-save"),className:"btn btn-primary",method:function(o,l){typeof F.myPreference<"u"?n():(P.set(s.data()),l.close())}}],onShow(o){var l=$("#"+o.modalId);mw.hook("InPageEdit.preference.modal").fire({$modal:o,$modalWindow:l}),typeof F.myPreference<"u"&&i.before($("<div>",{class:"has-local-warn",style:"padding-left: 8px; border-left: 6px solid orange; font-size: small;",html:t("preference-savelocal-popup-haslocal")})),a(e);var c=P.get("plugins"),w=O.loadCache();w?k(w):O.get().then(b=>{O.saveCache(b),k(b)});function k(b){r.find("#plugin-container").html($("<ul>")),$.each(b,(d,f)=>{var v=f.name||"Unknown",p=f.description||"",m=f.author?$("<a>",{href:"https://github.com/"+f.author,target:"_balnk",text:"@"+f.author}):"-";r.find("#plugin-container > ul").append($("<li>").append($("<label>").append($("<input>",{class:"plugin-checkbox",id:d,type:"checkbox",checked:c.indexOf(d)>=0||f._force===!0,disabled:f._force===!0}).on("change",function(){var g=$(this),N=g.prop("checked"),E=s.data("plugins"),I=E.indexOf(d);N&&I<0&&E.push(d),!N&&I>=0&&E.splice(I,1)}),$("<span>"),$("<div>",{class:"plugin-name",text:v}),$("<div>",{class:"plugin-author",html:m}),$("<div>",{class:"plugin-description",text:p}))))})}const u=h.wgUserName;$.get(`${X}/query/user`,{userName:u,siteUrl:ge(),prop:"*"}).then(b=>{r.find("#analysis-container").html("");const d=b.body.query[0],f=d._total,v=`${ce}/user?${$.param({userName:u,siteUrl:d.siteUrl})}`;let p=d.features;p=p.sort((g,N)=>N.count-g.count);const m=$("<table>",{class:"wikitable",style:"width: 96%"}).append($("<tr>").append($("<th>",{text:"ID"}),$("<th>",{text:"Count"}),$("<th>",{text:"%"})));p.forEach(({count:g,featureID:N})=>{m.append($("<tr>").append($("<th>",{text:N}),$("<td>",{text:g}),$("<td>",{text:(g/f*100).toFixed(2)+"%"})))}),r.find("#analysis-container").append($("<h4>",{text:`${d.userName}@${d.siteName}`}),$("<p>").append(J({href:v,text:"Analytics Dashboard →"})),$("<p>").append(t("preference-analysis-totaluse",f)),m)})}})}};function x(e){P.get("doNotCollectMyInfo");const i={siteUrl:ge(),siteName:h.wgSiteName,userName:h.wgUserName,featureID:e,ipeVersion:S};$.ajax({url:`${X}/submit`,data:i,type:"post",dataType:"json"}).done(function(n){console.log("[InPageEdit] Analytics response",n)})}function ge(){return`${h.wgServer}${h.wgArticlePath.replace("$1","")}`}const Me=function(){ssi_modal.show({title:t("preference-about-label"),className:"in-page-edit in-page-edit-about",content:$("<section>").append($("<iframe>",{style:"margin: 0;padding: 0;width: 100%;height: 80vh;border: 0;",src:Y}))})},B=function(e){const i=mw.config.get();return console.info("[InPageEdit] _hasRight",e,i.wgUserIsBlocked,i.wgUserRights),i.wgUserIsBlocked?!1:(i.wgUserRights||[]).includes(e)};function z(e){if(e===!0)$(".in-page-edit.loadingbox .ssi-modalTitle").html(t("done")),$(".in-page-edit.loadingbox .ipe-progress").addClass("done");else if(e===!1)$(".in-page-edit.loadingbox").length>0&&($(".in-page-edit.loadingbox").appendTo("body"),ssi_modal.close());else{if($(".in-page-edit.loadingbox").length>0)return;typeof e>"u"&&(e="Loading..."),ssi_modal.show({title:e,content:L,className:"in-page-edit loadingbox",center:!0,sizeClass:"dialog",closeIcon:!1,outSideClose:!1})}}function ne(e,i="large",n=!1){var r={action:"parse",preview:!0,disableeditsection:!0,prop:"text",format:"json"},s=$.extend({},r,e);mw.hook("InPageEdit.quickPreview").fire(),console.time("[InPageEdit] Request preview");const a=$("<div>").append(L),o=$("<div>",{class:"InPageEditPreview",style:"display:none",text:t("preview-placeholder")});o.on("click",function(l){l.preventDefault(),l.stopPropagation()}),ssi_modal.show({sizeClass:["dialog","small","smallToMedium","medium","mediumToLarge","large","full","auto"].includes(i)?i:"large",center:!!n,className:"in-page-edit previewbox",title:t("preview-title"),content:$("<section>").append(a,o),fixedHeight:!0,fitScreen:!0,buttons:[{label:"",className:"hideThisBtn"}],onShow(){a.css("margin-top",window.innerHeight/2-100),$(".previewbox .hideThisBtn").hide(),U().post(s).then(function(l){console.timeEnd("[InPageEdit] Request preview");const c=l.parse.text;a.hide(150),o.fadeIn(500).html(c)}).fail(function(){console.timeEnd("[InPageEdit] Request preview"),console.warn("[InPageEdit] 预览失败"),a.hide(150),o.fadeIn(500).html(t("preview-error"))})}})}function T(e){mw.hook("InPageEdit.quickDiff").fire(),x("quick_diff"),mw.loader.load(["mediawiki.legacy.shared","mediawiki.diff.styles"]);var i,n,r,s=$(".quick-diff");s.length>0?(console.info("[InPageEdit] Quick diff 正在加载新内容"),i=s.find(".pageName"),n=s.find(".diffArea"),r=s.find(".ipe-progress"),i.text(t("diff-loading")),n.hide(),s.appendTo(document.body)):(i=$("<span>",{class:"pageName",text:t("diff-loading")}),n=$("<div>",{class:"diffArea",style:"display: none"}),r=$(L),ssi_modal.show({className:"in-page-edit quick-diff",sizeClass:"large",fixedHeight:!0,fitScreen:!0,title:i,content:$("<div>").append(r,n),buttons:[{label:t("diff-button-todiffpage"),className:"btn btn-secondary toDiffPage"}]}),s=$(".quick-diff")),r.show().css("margin-top",s.find(".ssi-modalContent").height()/2),s.find(".toDiffPage").off("click"),e.action="compare",e.prop="diff|rel|ids|title|user|parsedcomment|size|timestamp",e.format="json",e.totext?e.topst=!0:e.fromtext&&(e.frompst=!0),U().post(e).done(function(a){const o=a.compare.body;let l;r.hide(),e.pageName===void 0?l=a.compare.totitle:l=e.pageName;function c(k){const u=$("<a>",{class:"diff-user",href:mw.util.getUrl("User:"+k),text:k}),b=$("<a>",{href:mw.util.getUrl("User_talk:"+k),text:t("diff-usertalk")}),d=$("<a>",{href:mw.util.getUrl("Special:Contributions/"+k),text:t("diff-usercontrib")}),f=$("<a>",{href:mw.util.getUrl("Special:Block/"+k),text:t("diff-userblock")});return $("<span>",{class:"diff-user-links"}).append(u," (",b," | ",d," | ",f,")")}function w(k){const u=new Date(k),b=Intl.DateTimeFormat("default",{weekday:"narrow"}).format(u);return`${Intl.DateTimeFormat("default",{dateStyle:"medium",timeStyle:"short"}).format(u)} (${b})`}i.html(t("diff-title")+": <u>"+l+"</u>"),n.show().empty().append($("<table>",{class:"diff difftable"}).append($("<colgroup>").append($("<col>",{class:"diff-marker"}),$("<col>",{class:"diff-content"}),$("<col>",{class:"diff-marker"}),$("<col>",{class:"diff-content"})),$("<tbody>").append($("<tr>").append($("<td>",{colspan:2,class:"diff-otitle"}).append($("<a>",{href:mw.util.getUrl("",{oldid:a.compare.fromrevid}),text:a.compare.fromtitle})," (",$("<span>",{class:"diff-version",text:t("diff-version")+a.compare.fromrevid}),") (",$("<a>",{class:"editLink",href:mw.util.getUrl(a.compare.fromtitle,{action:"edit",oldid:a.compare.fromrevid}),text:t("diff-edit")}),")",y,c(a.compare.fromuser),a.compare.fromtimestamp?[y,w(a.compare.fromtimestamp)]:"",a.compare.fromparsedcomment?[y,$("<span>",{class:"diff-comment"}).append(" (",a.compare.fromparsedcomment,") ")]:"",y,$("<a>",{class:"prevVersion ipe-analysis-quick_diff_modalclick",href:"javascript:void(0);",text:"←"+t("diff-prev")}).toggle(!!a.compare.prev).on("click",()=>{T({fromrev:a.compare.prev,torev:a.compare.fromrevid})})),$("<td>",{colspan:2,class:"diff-ntitle"}).append($("<a>",{href:mw.util.getUrl("",{oldid:a.compare.torevid}),text:a.compare.totitle})," (",$("<span>",{class:"diff-version",text:t("diff-version")+a.compare.torevid}),") (",$("<a>",{class:"editLink",href:mw.util.getUrl(a.compare.totitle,{action:"edit",oldid:a.compare.torevid}),text:t("diff-edit")}),")",y,c(a.compare.touser),a.compare.totimestamp?y+w(a.compare.totimestamp):"",a.compare.toparsedcomment?[y,$("<span>",{class:"diff-comment"}).append(" (",a.compare.toparsedcomment,") ")]:"",y,$("<a>",{class:"nextVersion ipe-analysis-quick_diff_modalclick",href:"javascript:void(0);",text:t("diff-nextv")+"→"}).toggle(!!a.compare.next).on("click",()=>{x("quick_diff_modalclick"),T({fromrev:a.compare.torevid,torev:a.compare.next})}))),o,$("<tr>",{class:"diffSize",style:"text-align: center"}).append($("<td>",{colspan:"2",text:a.compare.fromsize+t("diff-bytes")}),$("<td>",{colspan:"2",text:a.compare.tosize+t("diff-bytes")}))))),s.find("button.toDiffPage").on("click",function(){location.href=mw.util.getUrl("",{oldid:a.compare.fromrevid,diff:a.compare.torevid})}),se(s.find(".editLink")),e.isPreview===!0&&(s.find("button.toDiffPage").hide(),n.find(".diff-otitle").html("<b>"+t("diff-title-original-content")+"</b>"),n.find(".diff-ntitle").html("<b>"+t("diff-title-your-content")+"</b>")),(a.compare.fromsize===void 0||a.compare.tosize===void 0)&&n.find(".diffSize").hide(),!a.compare?.fromrevid&&!e.isPreview&&n.find(".diff-otitle").empty().append($("<span>",{class:"noPrevVerson",text:a?.warnings?.compare?.info||"Previous version not exist"})),!a.compare?.torevid&&!e.isPreview&&n.find(".diff-otitle").empty().append($("<span>",{class:"noNextVerson",text:a?.warnings?.compare?.info||"Next version not exist"})),a.compare.fromtexthidden!==void 0&&n.find(".diff-otitle .diff-version").addClass("diff-hidden-history"),a.compare.totexthidden!==void 0&&n.find(".diff-ntitle .diff-version").addClass("diff-hidden-history"),a.compare.fromuserhidden!==void 0&&n.find(".diff-otitle .diff-user").addClass("diff-hidden-history"),a.compare.touserhidden!==void 0&&n.find(".diff-ntitle .diff-user").addClass("diff-hidden-history"),a.compare.fromcommenthidden!==void 0&&n.find(".diff-comment").addClass("diff-hidden-history"),a.compare.tocommenthidden!==void 0&&n.find(".diff-ntitle .diff-comment").addClass("diff-hidden-history")}).fail(function(a,o){console.warn("[InPageEdit] 快速差异获取失败"),r.hide(),o.error&&o.error.info&&o.error.code?n.show().html(t("diff-error")+": "+o.error.info+"(<code>"+o.error.code+"</code>)"):n.show().html(t("diff-error"))})}const ae=e=>new RegExp(`^(File|${h.wgFormattedNamespaces[6]}):`).test(e),Oe=e=>{var i={format:"json",action:"query",prop:ae(e)?"fileusage":"linkshere",titles:e};return ae(e)?i.fulimit="max":i.lhlimit="max",U().get(i)},He=e=>{var i=$("<ol>",{class:"ipe-links-here-list"});return $.each(e,(n,{title:r,redirect:s})=>{i.append($("<li>").append(J({page:r}).attr({rel:"noopener",target:"_blank"}),s!==void 0?" (<i>"+t("links-here-isRedirect")+"</i>)":""," (",J({text:"← "+t("links-here")}).on("click",function(){V(r)})," | ",J({text:t("quick-edit")}).on("click",function(){A({page:r,reload:!1})}),")"))}),i};async function V(e=h.wgPageName){x("linkshere"),(!e||typeof e!="string")&&(e=h.wgPageName);var i=$(L),n=$("<div>").append(i),r=ssi_modal.createObject({className:"in-page-edit ipe-links-here",center:!0,sizeClass:"dialog",onShow(l){mw.hook("InPageEdit.linksHere").fire({modal:l,$modal:$("#"+l.modalId)})}}).init();r.setTitle(t("links-here-title",e,2)),r.setContent(n),r.show();try{console.info("[InPageEdit] linksHere","开始获取页面信息");const l=await Oe(e),{pages:c}=l.query;console.info("[InPageEdit] linksHere","成功获取页面信息");var s=Object.keys(c)[0],a=[];if(ae(e)?a=c[s].fileusage||[]:a=c[s].linkshere||[],i.hide(),a.length>0){var o=He(a);n.append(o)}else n.append($("<div>",{class:"ipe-links-here-no-page",html:t("links-here-no-page",e)}));return a.length<2&&r.setTitle(t("links-here-title",e,1)),s==="-1"&&n.append($("<div>",{html:t("links-here-not-exist",e),class:"ipe-links-here-not-exist"})),mw.hook("InPageEdit.linksHere.pageList").fire(a),a}catch(l){return i.hide(),n.append($("<p>",{class:"error",html:l})),console.error("[InPageEdit] linksHere","获取页面信息时出现问题",l),l}}function A(e){const i=U();e=e||{},typeof e=="string"&&(e={page:e||h.wgPageName});var n={page:h.wgPageName,pageId:-1,revision:null,summaryRevision:"",section:null,editText:"",editMinor:!1,editSummary:t("preference-summary-default"),editNotice:"",outSideClose:!0,jsonGet:{action:"parse",page:e.page||h.wgPageName,prop:"wikitext|langlinks|categories|templates|images|sections",format:"json"},jsonPost:{},pageDetail:{},jumpTo:"",reload:!0,watchList:"preferences"},r=P.get(),s=new Date,a=s.getTime(),o=s.toISOString();e=$.extend({},n,e,r),x("quick_edit"),e.revision&&e.revision!==h.wgCurRevisionId&&(ssi_modal.notify("warning",{className:"in-page-edit",content:t("notify-editing-history"),title:t("notify-info")}),delete e.jsonGet.page,e.jsonGet.oldid=e.revision,e.summaryRevision=`(${t("editor-summary-revision")} [[Special:Permalink/${e.revision}]])`),e.section&&e.section!=="new"&&(e.jsonGet.section=e.section),e.section==="new"&&delete e.revision;var l=$("<span>").append(t("editor-title-editing")+': <u class="editPage">'+e.page.replace(/_/g," ")+"</u>"),c=$("<textarea>",{class:"editArea",style:"margin-top: 0;"}),w=$("<div>",{class:"editOptionsLabel hideBeforeLoaded"}).append($("<section>",{class:"detailArea"}).append($("<label>",{class:"detailToggle",text:t("editor-detail-button-toggle")}),$("<div>",{class:"detailBtnGroup"}).append($("<a>",{href:"javascript:;",class:"detailBtn",id:"showTemplates",text:t("editor-detail-button-templates")})," | ",$("<a>",{href:"javascript:;",class:"detailBtn",id:"showImages",text:t("editor-detail-button-files")})," | ",$("<a>",{href:"javascript:;",class:"detailBtn",id:"linksHereBtn",text:t("links-here"),"data-page-name":e.page}).on("click",function(){V(e.page)}))),$("<label>",{for:"editSummary",text:t("editSummary")}),y,$("<input>",{class:"editSummary",id:"editSummary",placeholder:"Edit via InPageEdit~",value:e.editSummary.replace(/\$oldid/gi,e.summaryRevision)}),y,$("<label>").append($("<input>",{type:"checkbox",class:"editMinor",id:"editMinor",checked:e.editMinor}),$("<span>",{text:t("markAsMinor")}))," ",$("<label>").append($("<input>",{type:"checkbox",class:"watchList",id:"watchList",checked:e.watchList==="watch",disabled:["nochange","preferences"].includes(e.watchList)}),$("<span>",{text:t("watchThisPage")}))," ",y,$("<label>").append($("<input>",{type:"checkbox",class:"reloadPage",id:"reloadPage",checked:e.reload}),$("<span>",{text:t("editor-reload-page")})));["nochange","preferences"].includes(e.watchList)&&w.find(".watchList").parent().one("click",function(d){d.preventDefault(),$(this).removeAttr("title").children("input").prop("disabled",!1)}).attr("title",t("unlockWatchList"));var k=$("<input>",{type:"text",class:"newSectionTitleInput",placeholder:t("editor-new-section")}),u=$("<div>").append(L,$("<section>",{class:"hideBeforeLoaded"}).append(c));e.section==="new"&&u.prepend($("<label>",{class:"newSectionTitleArea"}).append(t("editor-new-section"),"<br>",k)),console.time("[InPageEdit] 获取页面源代码"),console.info("[InPageEdit] QuickEdit options",e),ssi_modal.show({title:l,content:u,outSideClose:e.outSideClose,className:"in-page-edit ipe-editor timestamp-"+a,sizeClass:"large",buttons:[{side:"left",label:t("editor-button-save"),className:"btn btn-primary leftBtn hideBeforeLoaded save-btn",keyPress:"ctrl-s",method(d,f){if(console.log({title:k.val(),content:c.val()}),e.section==="new"&&(!k.val().trim()||!c.val().trim())){ssi_modal.notify("error",{className:"in-page-edit",position:"right top",closeAfter:{time:15},title:t("notify-error"),content:t("editor-new-section-missing-content")});return}async function v(p){if(p){let m=w.find(".editSummary").val(),g;if(e.section==="new"){g=k.val();const C=(await i.post({action:"parse",text:`==${g}==`,contentmodel:"wikitext",prop:"sections",formatversion:2})).parse.sections[0].anchor;m=m.replace(/\$section/gi,`/* ${C} */`)}const N=c.val(),E=w.find(".editMinor").prop("checked"),I=e.section,D=m,q=w.find(".watchList").prop("checked")?"watch":"unwatch",j=w.find(".watchList").prop("disabled")?e.watchList:q;b({text:N,page:e.page,minor:E,section:I,sectiontitle:g,summary:D,watchlist:j},f)}}e.noConfirmEdit?v(!0):ssi_modal.confirm({className:"in-page-edit",center:!0,content:t("editor-confirm-save"),okBtn:{className:"btn btn-primary",label:t("confirm")},cancelBtn:{className:"btn btn-secondary",label:t("cancel")}},v)}},{side:"left",label:t("editor-button-preview"),className:"btn btn-secondary leftBtn hideBeforeLoaded",method(){x("preview_edit");var d=c.val();ne({title:e.page,text:d,pst:!0,section:e.section==="new"?"new":void 0,sectiontitle:e.section==="new"?k.val():void 0})}},{side:"left",label:t("editor-button-diff"),className:"btn btn-secondary leftBtn hideBeforeLoaded diff-btn"},{label:t("cancel"),className:"btn btn-danger",method(d,f){f.close()}}],beforeShow(d){var f=$("#"+d.modalId);f.find(".hideBeforeLoaded").hide(),u.find(".ipe-progress").css("margin",Number($(window).height()/3-50)+"px 0"),c.css("height",$(window).height()/3*2-100),f.find(".ssi-buttons").prepend(w),f.find(".ssi-modalTitle").append($("<a>",{class:"showEditNotice",href:"javascript:void(0);",html:'<i class="fa fa-info-circle"></i> '+t("editor-has-editNotice"),style:"display: none;"}).on("click",function(){ssi_modal.show({className:"in-page-edit",center:!0,title:t("editor-title-editNotice"),content:'<section class="editNotice">'+u.data("editNotice")+"</section>"})}))},onShow(d){d.options.onShow="";var f=$("#"+d.modalId);mw.hook("InPageEdit.quickEdit").fire({$modal:d,$modalWindow:f,$modalTitle:l,$modalContent:u,$editArea:c,$optionsLabel:w}),c.change(function(){$(this).attr("data-modifiled","true"),$(window).bind("beforeunload",function(){return t("window-leave-confirm")})}),B("edit")||(ssi_modal.notify("dialog",{className:"in-page-edit",position:"center bottom",title:t("notify-no-right"),content:t("editor-no-right"),okBtn:{label:t("ok"),className:"btn btn-primary",method(p,m){m.close()}}}),f.find(".save-btn").addClass("btn-danger")),i.get(e.jsonGet).done(function(p){console.timeEnd("[InPageEdit] 获取页面源代码"),v(p)}).fail(function(p,m,g){console.timeEnd("[InPageEdit] 获取页面源代码"),console.warn("[InPageEdit]警告：无法获取页面内容");var N=g;v(N)});function v(p){e.pageDetail=p,p.error?(console.warn("[InPageEdit]警告：无法获取页面内容"),e.editText="<!-- "+p.error.info+" -->",e.pageId=-1,w.find(".detailArea").hide()):(e.editText=e.section==="new"?"":p.parse.wikitext,e.pageId=p.parse.pageid),u.find(".ipe-progress").hide(),f.find(".hideBeforeLoaded").fadeIn(500),c.val(e.editText+`
`);var m;e.section&&e.section!=="new"?(m=w.find(".editSummary").val(),m=m.replace(/\$section/gi,`/* ${p.parse.sections[0].anchor} */`),w.find(".editSummary").val(m),l.find(".editPage").after('<span class="editSection"> → '+p.parse.sections[0].line+"</span>"),e.jumpTo="#"+p.parse.sections[0].anchor):e.section!=="new"&&(m=w.find(".editSummary").val(),m=m.replace(/\$section/gi,""),w.find(".editSummary").val(m),e.jumpTo=""),e.revision!==null&&e.revision!==""&&e.revision!==h.wgCurRevisionId&&e.section!=="new"?(l.find(".editPage").after('<span class="editRevision">('+t("editor-title-editRevision")+"："+e.revision+")</span>"),f.find(".diff-btn").on("click",function(){x("quick_diff_edit");var E=c.val(),I={fromrev:e.revision,totext:E,hideBtn:!0,pageName:e.page,isPreview:!0};e.section&&(I.fromsection=e.section),T(I)})):f.find(".diff-btn").attr("disabled",!0),console.time("[InPageEdit] 获取页面基础信息");var g={action:"query",prop:"revisions|info",inprop:"protection|watched",format:"json"};e.pageId!==-1?g.pageids=e.pageId:g.titles=e.page,i.get(g).done(function(E){console.info("[InPageEdit] 获取页面基础信息成功"),console.timeEnd("[InPageEdit] 获取页面基础信息"),u.data("basetimestamp",E.query.pages?.[0]?.revisions?.[0]?.timestamp??o),u.data("starttimestamp",E.query.pages?.[0]?.touched,o),N(E)}).fail(function(E,I,D){var q=D;console.timeEnd("[InPageEdit] 获取页面基础信息"),console.warn("[InPageEdit] 获取页面基础信息失败"),u.data("basetimestamp",o),u.data("starttimestamp",o),N(q)});function N(E){const I=E.query.pages[0];if(e.namespace=I?.ns??0,e.protection=I?.protection||[],e.revision=I?.revisions?.[0]?.revid,e.page=I.title,l.find(".editPage").text(e.page),e.watchList==="nochange"&&w.find(".watchList").prop("disabled",!1).prop("checked",I.watched).off("click").removeAttr("title"),e.revision&&e.section!=="new"&&f.find(".diff-btn").removeAttr("disabled").on("click",function(){x("quick_diff_edit");var j=c.val(),C={fromrev:e.revision,totext:j,hideBtn:!0,pageName:e.page,isPreview:!0};e.section&&(C.fromsection=e.section),T(C)}),e.protection.length>0){const j=_=>_?B(_.replace("sysop","editprotected").replace("autoconfirmed","editsemiprotected")):!0,C=e.protection.find(({type:_})=>_==="edit");(!j(C?.level)||e.namespace===8&&!B("editinterface"))&&f.find(".save-btn").addClass("btn-danger").attr("title",t("editor-no-right"))}const D="Editnotice-"+e.namespace,q=D+"-"+e.page.replace(/_/g," ").replace(h.wgFormattedNamespaces[e.namespace]+":","");i.get({action:"query",meta:"allmessages",ammessages:[D,q],amenableparser:1}).done(function(j){const C=j.query.allmessages[0].content||"",_=j.query.allmessages[1].content||"",M=C+`
`+_;M.trim()&&i.post({action:"parse",text:M,title:e.page,preview:!0,disablelimitreport:!0,disableeditsection:!0,disabletoc:!0}).then(H=>{const Je=H.parse.text;u.data("editNotice",Je),f.find(".showEditNotice").show()})})}}},beforeClose(d){if(c.attr("data-modifiled")!=="true"){f();return}else if(c.attr("data-confirmclose")==="true"){v();return}ssi_modal.confirm({className:"in-page-edit",center:!0,content:t("editor-leave-confirm"),okBtn:{className:"btn btn-danger",label:t("confirm")},cancelBtn:{className:"btn btn-secondary",label:t("cancel")}},function(p){p===!0&&f()});function f(){$(window).off("beforeunload"),d.options.keepContent=!1,d.options.beforeClose="",d.close(),ssi_modal.notify("info",{className:"in-page-edit",position:"right top",title:t("cancel"),content:t("notify-no-change")})}function v(){$(window).off("beforeunload"),d.options.keepContent=!1,d.options.beforeClose="",d.close()}return!1}}),w.find(".detailBtnGroup .detailBtn").on("click",function(){x("quick_edit_pagedetail");var d=$(this),f=d.attr("id"),v=$("<ul>");switch(f){case"showTemplates":{const p=e.pageDetail.parse.templates;console.info("[InPageEdit] QuickEdit","模板列表",p);for(let m=0;m<p.length;m++){let g=p[m].title;$("<li>").append($("<a>",{href:mw.util.getUrl(g),rel:"noopener",target:"_blank",text:g})," (",$("<a>",{href:"javascript:;",text:t("quick-edit"),class:"quickEditTemplate","data-template-name":g})," | ",$("<a>",{href:"javascript:;",text:t("links-here"),class:"quickEditLinksHere"}).on("click",function(){V(g)}),")").appendTo(v)}ssi_modal.show({className:"in-page-edit quick-edit-detail",sizeClass:"dialog",title:t("editor-detail-title-templates"),content:v});break}case"showImages":{const p=e.pageDetail.parse.images;for(let m=0;m<p.length;m++){const g=p[m];$("<li>").append($("<a>",{href:mw.util.getUrl("File:"+g),target:"_balnk",text:g})," (",$("<a>",{href:"javascript:;",class:"quickViewImage",text:t("editor-detail-images-quickview"),"data-image-name":g})," | ",$("<a>",{href:h.wgScript+"?title=Special:Upload&wpDestFile="+g+"&wpForReUpload=1",target:"_balnk",text:t("editor-detail-images-upload")}),"|",$("<a>",{href:"javascript:;",text:t("links-here"),class:"quickEditLinksHere"}).on("click",function(){V(`File:${g}`)}),")").appendTo(v)}ssi_modal.show({className:"in-page-edit quick-edit-detail",sizeClass:"dialog",title:t("editor-detail-title-files"),content:v});break}}$(".in-page-edit.quick-edit-detail .quickEditTemplate").on("click",function(){x("quick_edit_pagedetail_edit_template");var p=$(this),m=p.attr("data-template-name");A({page:m})}),$(".in-page-edit.quick-edit-detail .quickViewImage").on("click",function(){x("quick_edit_pagedetail_view_image");var p=$(this),m=p.attr("data-image-name");ssi_modal.show({className:"in-page-edit quick-view-image",center:!0,title:m.replace(/_/g," "),content:$("<center>",{id:"imageLayer"}).append(L),buttons:[{label:t("editor-detail-images-upload"),className:"btn btn-primary",method(){window.open(mw.util.getUrl("Special:Upload",{wpDestFile:m,wpForReUpload:1}))}},{label:t("close"),className:"btn btn-secondary",method(g,N){N.close()}}],onShow(){i.get({action:"query",format:"json",prop:"imageinfo",titles:`File:${m.replace(/file:/g,"")}`,iiprop:"url"}).done(function(g){$(".quick-view-image .ipe-progress").hide(),$(".quick-view-image #imageLayer").append($("<img>",{src:g.query.pages[-1].imageinfo[0].url,class:"loading",style:"max-width: 80%; max-height: 60vh"})),$(".quick-view-image #imageLayer img").load(function(){$(this).removeClass("loading")})})}})})});function b({text:d,page:f,minor:v,summary:p,section:m,sectiontitle:g,watchlist:N},E){x("quick_edit_save"),z(t("editor-title-saving")),e.jsonPost={action:"edit",starttimestamp:u.data("starttimestamp"),basetimestamp:u.data("basetimestamp"),text:d,title:f,watchlist:N,summary:p,errorformat:"plaintext",...v?{minor:!0}:{notminor:!0}},m!==void 0&&m!==""&&m!==null&&(e.jsonPost.section=m),g!==void 0&&g!==""&&(e.jsonPost.sectiontitle=g,e.jumpTo="#"+g),i.postWithToken("csrf",e.jsonPost).done(I).fail(D);function I(q,j,C){if(q.edit.result==="Success"){if(z(!0),w.find(".reloadPage").prop("checked")){var _;$(window).unbind("beforeunload"),_=t("notify-save-success"),setTimeout(function(){f===h.wgPageName&&(window.location=mw.util.getUrl(f)+e.jumpTo),window.location.reload()},500)}else console.info("[InPageEdit] 将不会重载页面！"),_=t("notify-save-success-noreload"),setTimeout(function(){z(!1),c.attr("data-confirmclose","true"),E.close()},1500);ssi_modal.notify("success",{className:"in-page-edit",position:"right top",title:t("notify-success"),content:_})}else D(q,j,C)}function D(q,j,C){z(!1);var _=C||q,M,H="";_.errors!==void 0?(q=_.errors[0].code,M=_.errors[0]["*"],H=""):_.edit.result!=="Success"?(q=_.edit.code||"Unknown",M=_.edit.info||"Reason unknown.",H=_.edit.warning||""):(q="unknown",M="Reason unknown.",H="Please contact plug-in author or try again."),ssi_modal.show({className:"in-page-edit",sizeClass:"dialog",center:!0,title:t("editor-save-error"),content:M+'<hr style="clear: both" />'+H}),ssi_modal.notify("error",{className:"in-page-edit",position:"right top",closeAfter:{time:15},title:t("notify-error"),content:t("editor-save-error")+"：<code>"+q+"</code>"}),console.error(`[InPageEdit] Submit failed: 
Code: `+q)}}}function se(e){e||(P.get("redLinkQuickEdit")===!0?e=$("#mw-content-text a, #firstHeading a"):e=$("#mw-content-text a:not(.new), #firstHeading a:not(.new)")),$(e).each(function(n,r){const s=r.getAttribute("href");if(!s||/^(?:#|javascript:|vbscript:|data:)/i.test(s))return;const a=r.href,o=h.wgArticlePath.replace("$1",""),l=`${location.protocol}//${h.wgServer.split("//")[1]}`,c=`${l}${o}`,w=`${l}${h.wgScriptPath}`;if(!a.startsWith(c)&&!a.startsWith(w))return;const k=new URL(a),u=k.searchParams,b=u.get("action")||u.get("veaction"),d=u.get("title")||decodeURI(k.pathname.substring(o.length))||null,f=u.get("section")?.replace(/^T-/,"")||null,v=u.get("oldid");if(!d||d.endsWith(".php")||!["edit","editsource","editredlink","submit"].includes(b)||u.get("undo")||u.get("preload"))return;const p=$("<span>",{class:"in-page-edit-article-link-group"}).append($("<a>",{href:a,class:"in-page-edit-article-link",text:t("quick-edit")}).on("click",function(m){m.preventDefault();var g={};g.page=d,v!==null?g.revision=v:f!==null&&(g.section=f),h.wgIsArticle||(g.reload=!1),A(g)}));$(r).addClass("ipe-articleLink-resolved").after(p)})}const We=e=>{const i=e.originalEvent||e;return i.altKey||i.ctrlKey||i.metaKey||i.shiftKey},he=e=>(e.originalEvent||e).button===0&&!We(e),{getParamValue:Q}=mw.util;function Fe(e){$(e||"#mw-content-text").find("a[href]:not(.ipe-diff-mounted)").toArray().forEach(i=>{const n=$(i),r=n.attr("href");let s=Q("diff",r),a=Q("curid",r),o=Q("oldid",r),l=Q("timestamp",r);const c=["prev","next","cur"],w=(mw.config.get("wgSpecialPageAliases",[]).find(({realname:p})=>p==="Diff")?.aliases.map(p=>[p,encodeURI(p)]).flat()||["Diff"]).join("|"),k=h.wgArticlePath.replace("$1",""),u=`Special|${h.wgFormattedNamespaces[-1]}`,b=new RegExp(`^${k}(?:${u}):(?:${w})/(\\d+|${c.join("|")})(?:/(\\d+|${c.join("|")}))?$`),d=r.match(b);if(d&&(s=d[2]||d[1],o=d[2]?d[1]:"prev"),s===null||l!==null)return;!o&&!a&&(o="prev"),c.includes(o)&&([s,o]=[o,s]),n.addClass("ipe-diff-mounted");const f={},v=p=>c.includes(p)||p===null?"relative":p==="0"?"id":"rev";f[`from${v(o)}`]=o,f[`to${v(s)}`]=s!=="0"?s:a,n.attr("ipe-diff-params",JSON.stringify(f)),n.on("click",function(p){if(he(p))return p.preventDefault(),x("quick_diff_recentchanges"),T(f)})})}function we(e){Fe(e),h.wgAction==="history"&&($(".historysubmit.mw-history-compareselectedversions-button").after($("<button>").text(t("quick-diff")).on("click",function(i){if(!he(i))return;i.preventDefault(),x("quick_diff_history_page");const n=$(".selected.before").attr("data-mw-revid"),r=$(".selected.after").attr("data-mw-revid");T({fromrev:r,torev:n})})),$("[data-mw-revid]").each(function(){var i=$(this),n=i.attr("data-mw-revid");i.find(".mw-history-undo").after($("<span>").append(" | ",$("<a>",{href:"javascript:;",class:"in-page-edit-article-link",text:t("quick-edit")}).on("click",function(){A({page:h.wgPageName,revision:n})})))}))}function re(e,i=""){mw.hook("InPageEdit.quickDelete").fire(),console.log("Quick delete",e,i);let n="";e=e||h.wgPageName,ssi_modal.show({outSideClose:!1,className:"in-page-edit quick-delete",center:!0,sizeClass:"dialog",title:t("delete-title"),content:$("<div>").append($("<section>",{id:"InPageEditDeletepage"}).append($("<span>",{html:t("delete-reason","<b>"+e.replace(/_/g," ")+"</b>")}),y,$("<label>",{for:"delete-reason",text:t("editSummary")}),$("<input>",{id:"delete-reason",style:"width:96%",onclick:"$(this).css('box-shadow', '')",value:i}))),beforeShow:function(){if(!B("delete"))return ssi_modal.dialog({title:t("notify-no-right"),content:t("delete-no-right"),className:"in-page-edit quick-deletepage",center:!0,okBtn:{className:"btn btn-primary btn-single"}}),!1},buttons:[{label:t("cancel"),className:"btn btn-primary",method:function(r,s){s.close()}},{label:t("confirm"),className:"btn btn-danger",method:function(r,s){if(n=$("#InPageEditDeletepage #delete-reason").val(),n===""){$("#InPageEditDeletepage #delete-reason").css("box-shadow","0 0 4px #f00");return}x("quick_delete"),ssi_modal.confirm({center:!0,className:"in-page-edit",title:t("delete-confirm-title"),content:t("delete-confirm-content"),okBtn:{label:t("confirm"),className:"btn btn-danger"},cancelBtn:{label:t("cancel"),className:"btn"}},function(a){if(a)n=t("delete-title")+" ("+n+")",U().postWithToken("csrf",{action:"delete",title:e,reason:n,format:"json"}).then(()=>{ssi_modal.notify("success",{className:"in-page-edit",title:t("notify-success"),content:t("notify-delete-success",e)})}).fail(function(o,l,c){ssi_modal.notify("error",{className:"in-page-edit",title:t("notify-error"),content:t("notify-delete-error")+': <br/><span style="font-size:amall">'+c.error.info+"(<code>"+c.error.code+"</code>)</span>"})}),s.close();else return!1})}}]})}const be=function(e,i={}){const n=B("delete");typeof i=="string"&&(i={delete:i,edit:i}),ssi_modal.show({className:"in-page-edit resovle-exists",sizeClass:"dialog",center:!0,outSideClose:!1,title:t("target-exists-title"),content:t(n?"target-exists-can-delete":"target-exists-no-delete",e),buttons:[{className:"btn btn-danger btn-exists-delete-target",label:t("quick-delete"),method(r,s){s.close(),re(e,i.delete||null)}},{className:"btn btn-primary",label:t("quick-edit"),method(){A({page:e,summary:i.edit?"[InPageEdit] "+i:null,reload:!1})}},{className:"btn btn-secondary"+(n?" btn-single":""),label:t("cancel"),method:(r,s)=>{s.close()}}],onShow:()=>{n||$(".btn-exists-delete-target").hide()}})};function $e(e="to"){mw.hook("InPageEdit.quickRedirect").fire();const i=U();var n="#REDIRECT [[:$1]]",r,s,a={action:"edit",createonly:1,minor:P.get("editMinor"),format:"json",errorformat:"plaintext"},o;if(e==="to")a.title=h.wgPageName,r=t("redirect-question-to","<b>"+h.wgPageName.replace(/_/g," ")+"</b>");else if(e==="from")r=t("redirect-question-from","<b>"+h.wgPageName.replace(/_/g," ")+"</b>"),o=t("redirect-summary")+" → [[:"+h.wgPageName+"]]";else{console.error('[InPageEdit] quickRedirect only accept "from" or "to"');return}ssi_modal.show({outSideClose:!1,className:"in-page-edit quick-redirect",center:!0,sizeClass:"dialog",title:t("redirect-title"),content:$("<div>").append($("<section>").append($("<span>",{html:r}),y,$("<input>",{id:"redirect-page",style:"width:96%"}).on("click",function(){$(this).css("box-shadow","")}),...e==="from"?[y,$("<label>",{for:"redirect-fragment",text:t("redirect-question-fragment")}),$("<input>",{id:"redirect-fragment",style:"width:96%"})]:[],y,$("<label>",{for:"redirect-reason",text:t("editSummary")}),$("<input>",{id:"redirect-reason",style:"width:96%"})),$(L).css("display","none")),buttons:[{label:t("confirm"),className:"btn btn-primary btn-single okBtn",method:function(l,c){if(s=$(".in-page-edit.quick-redirect #redirect-page").val(),s===""||s.replace(/_/g," ")===h.wgPageName.replace(/_/g," ")){$(".in-page-edit.quick-redirect #redirect-page").css("box-shadow","0 0 4px #f00");return}if(x("quick_redirect"),e==="to")o=t("redirect-summary")+" → [[:"+s+"]]",a.text=n.replace("$1",s);else if(e==="from"){let b=$(".in-page-edit.quick-redirect #redirect-fragment").val().trim();b&&!b.startsWith("#")&&(b=`#${b}`),a.title=s,a.text=n.replace("$1",`${h.wgPageName}${b}`)}$(".in-page-edit.quick-redirect #redirect-reason").val()!==""&&(o=o+" ("+$(".in-page-edit.quick-redirect #redirect-reason").val()+")"),a.summary=o,$(".in-page-edit.quick-redirect .ipe-progress").show(),$(".in-page-edit.quick-redirect section").hide(),$(".in-page-edit.quick-redirect .okBtn").attr("disabled","disabled");let w=Promise.resolve();P.get("noRedirectIfConvertedTitleExists")&&(w=i.get({titles:a.title,converttitles:1}).done(b=>{const d=b.query.pages[0];if(d?.missing!==!0)throw u("articleexists",{fromPage:d.title,errors:[{info:t("notify-redirect-converted-error")}]}),null}).fail((b,d)=>{throw u(b,d),null})),w.then(()=>{i.postWithToken("csrf",a).done(k).fail(u)},()=>{});function k(b){if(b.errors){u(b.errors[0].code,b);return}$(".in-page-edit.quick-redirect .ipe-progress").addClass("done"),ssi_modal.notify("success",{className:"in-page-edit",content:t("notify-redirect-success"),title:t("notify-success")}),e==="to"?window.location.reload():($(".in-page-edit.quick-redirect .ipe-progress").addClass("done"),setTimeout(function(){c.close()},2e3))}function u(b,d){if($(".in-page-edit.quick-redirect .ipe-progress").hide(),$(".in-page-edit.quick-redirect section").show(),$(".in-page-edit.quick-redirect .okBtn").attr("disabled",!1),$(".in-page-edit.quick-redirect .ipe-progress").addClass("done"),ssi_modal.notify("error",{className:"in-page-edit",content:t("notify-redirect-error")+"<br>"+d.errors[0].info+" (<code>"+b+"</code>)",title:t("notify-error")}),b==="articleexists"){var f,v;e==="from"?(f=d.fromPage??s,v=h.wgPageName):e==="to"&&(f=d.fromPage??h.wgPageName,v=s),be(f,{delete:"Delete for redirect to [["+v+"]]",edit:"Modify for redirect"})}}}}]})}function oe(e,i){mw.hook("InPageEdit.quickRename").fire(),e=e||h.wgPageName,i=i||"";var n,r,s,a;ssi_modal.show({outSideClose:!1,className:"in-page-edit quick-rename",center:!0,sizeClass:"dialog",title:t("rename-title"),content:$("<section>").append($("<label>",{for:"move-to",html:t("rename-moveTo","<b>"+e.replace(/_/g," ")+"</b>")}),y,$("<input>",{id:"move-to",style:"width:96%",onclick:"$(this).css('box-shadow','')"}),y,$("<label>",{for:"move-reason",text:t("editSummary")}),y,$("<input>",{id:"move-reason",style:"width:96%"}),y,$("<label>").append($("<input>",{type:"checkbox",id:"movetalk",checked:"checked"}),$("<span>",{text:t("rename-movetalk")})),y,$("<label>").append($("<input>",{type:"checkbox",id:"movesubpages",checked:"checked"}),$("<span>",{text:t("rename-movesubpages")})),y,$("<label>").append($("<input>",{type:"checkbox",id:"noredirect",disabled:!B("suppressredirect")}),$("<span>",{text:t("rename-noredirect")}))),buttons:[{label:t("cancel"),className:"btn btn-secondary",method:function(o,l){l.close()}},{label:t("confirm"),className:"btn btn-primary",method:function(){if(i=$(".in-page-edit.quick-rename #move-to").val(),i===""||i===h.wgPageName||i===h.wgPageName.replace(/_/g," ")){$(".in-page-edit.quick-rename #move-to").css("box-shadow","0 0 4px #f00");return}x("quick_move"),z(t("editor-title-saving")),r=$(".in-page-edit.quick-rename #movetalk").prop("checked"),s=$(".in-page-edit.quick-rename #movesubpages").prop("checked"),a=$(".in-page-edit.quick-rename #noredirect").prop("checked"),n=$(".in-page-edit.quick-rename #move-reason").val(),n===""?n=t("rename-summary")+" → [[:"+i+"]]":n=t("rename-summary")+" → [[:"+i+"]] ("+n+")",U().postWithToken("csrf",{action:"move",from:e,to:i,reason:n,movetalk:r,movesubpages:s,noredirect:a}).done(function(){z(!0),ssi_modal.notify("success",{className:"in-page-edit",content:t("notify-rename-success"),title:t("notify-success")}),location.href=h.wgArticlePath.replace("$1",encodeURI(i))}).fail(function(o,l,c){z(!1),ssi_modal.notify("error",{className:"in-page-edit",content:t("notify-rename-error")+": "+c.error.info+"<code>"+c.error.code+"</code>",title:t("notify-error")}),c.error.code==="articleexists"&&be(i,t("rename-articleexists-reason",e))})}}],beforeShow:function(){if(!B("move"))return ssi_modal.dialog({title:t("notify-no-right"),content:t("rename-no-right"),className:"in-page-edit quick-deletepage",center:!0,okBtn:{className:"btn btn-primary btn-single"}}),!1}})}function ve(){ssi_modal.notify("dialog",{className:"in-page-edit ipe-special-notice",title:t("version-notice-title"),content:t("version-notice"),okBtn:{label:t("updatelog-dismiss"),className:"btn btn-primary"}},function(e,i){localStorage.setItem("InPageEditNoticeId",t("noticeid")),i.close()})}function ke(){ssi_modal.show({className:"in-page-edit update-logs-modal",title:t("updatelog-title")+' - <span id="yourVersion">'+S+"</span>",content:$("<section>").append($("<iframe>",{style:"margin: 0;padding: 0;width: 100%;height: 80vh;border: 0;",src:fe})),buttons:[{label:"GitHub",className:"btn btn-secondary",method:function(){window.open(G)}},{label:t("updatelog-about"),className:"btn btn-secondary",method:function(){window.open(Y)}},{label:t("close"),className:"btn btn-primary",method:function(e,i){i.close()}}]})}function Ve(){localStorage.getItem("InPageEditVersion")!==S&&ssi_modal.notify("",{title:t("updatelog-update-success-title"),content:t("updatelog-update-success",S),className:"in-page-edit",buttons:[{className:"btn btn-primary",label:t("updatelog-button-versioninfo"),method(e,i){localStorage.setItem("InPageEditVersion",S),ke(),i.close()}}],closeAfter:{time:10,resetOnHover:!0},onClose(){localStorage.setItem("InPageEditVersion",S)}}),localStorage.getItem("InPageEditNoticeId")!==t("noticeid")&&ve()}async function Ge(){mw.hook("InPageEdit.init.before").fire(),await mw.loader.using(["mediawiki.api","mediawiki.util","mediawiki.user"]);const e=!!(mw.util.getParamValue("ipedev",location.href)||S!==localStorage.getItem("InPageEditVersion"));Ee(e),await Promise.all([Ce(e),le(`${R}/lib/ssi-modal/ssi-modal.js`),_e()]),mw.hook("InPageEdit.init.i18n").fire({_msg:t}),mw.hook("InPageEdit.init.modal").fire({ssi_modal:window.ssi_modal}),P.set(),mw.hook("wikipage.content").add(we),await $.ready,se(),Ve(),O.initUserPlugin();const i={_dir:W,about:Me,endpoints:Ne,articleLink:se,linksHere:V,loadQuickDiff:we,preference:P,progress:z,quickDelete:re,quickDiff:T,quickEdit:A,quickPreview:ne,quickRedirect:$e,quickRename:oe,specialNotice:ve,version:S,versionInfo:ke,delete:re,diff:T,edit:A,preview:ne,redirect:$e,quickMove:oe,rename:oe};return mw.hook("InPageEdit").fire({_analytics:x,_msg:t,InPageEdit:i}),window["".concat("console")].info(`    ____      ____                   ______    ___ __ 
   /  _/___  / __ \\____ _____ ____  / ____/___/ (_) /_
   / // __ \\/ /_/ / __ \`/ __ \`/ _ \\/ __/ / __  / / __/
 _/ // / / / ____/ /_/ / /_/ /  __/ /___/ /_/ / / /_  
/___/_/ /_/_/    \\__,_/\\__, /\\___/_____/\\__,_/_/\\__/  
                      /____/                v`+S),i}/**
 * @license GPL-3.0 GNU GENERAL PUBLIC LICENSE 3.0
 *
 * @name InPageEdit
 * @description A useful MediaWiki JavaScript Plugin written with jQuery
 * @author 机智的小鱼君 Dragon-Fish <dragon-fish@qq.com>
 * @url https://github.com/Dragon-Fish/InPageEdit-v2
 */(async function(){const e=window.InPageEdit||{};if(e.__loaded)throw"[InPageEdit] InPageEdit 被多次加载。";e.__loaded=!0;const i=await Ge();window.InPageEdit={...e,...i}})()});
//# sourceMappingURL=InPageEdit.min.js.map
